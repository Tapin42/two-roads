<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; display: none;}
    </style>
  </head>
  <body>
    <div id="splash">
      <div id="error"></div>
      <div id="parks"></div>
    </div>
    <div id="map"></div>

    <script type="text/javascript">

var map;
var server = 'http://localhost:8000/';

function ready() {
  $.ajax(server).done(function (data) {
    if (!data) {
      $('#error').html('Error downloading root manifest.');
      return;
    }

    try {
      if (data.error) {
        throw new Error(data.error);
      }

      data.parks.forEach(function (park) {
        var button = $('<button/>')
          .text(park)
          .click(function () {
            loadPark(park)
          });
        $('#parks').append(button);
      });

    } catch (e) {
      $('#error').html('Error handling JSON response: ' + e);
    }
  });
}

function loadPark(park) {
  $.ajax(server + park).done(function (data) {
    if (!data) {
      $('#error').html('Error downloading ' + park + ' manifest.');
      return;
    }

    initMap(data)
  })
}

function toggleMapVisibility(isVisible) {
  if (isVisible) {
    $('#splash').hide();
    $('#map').show();
  } else {
    $('#map').hide();
    $('#splash').show();
  }
}

function initMap(park) {
  toggleMapVisibility(true);

  map = new google.maps.Map(document.getElementById('map'), park.start);

  fetchOverlays(park, map);
  fetchSegments(park, map);
}

function fetchOverlays(park, map) {
  $.ajax(server + park.dir + '/overlays').then(function (data, textStatus, jqXHR) {
    data.maps.forEach(function (overlay) {
        var bounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(overlay.bounds[0], overlay.bounds[1]),
          new google.maps.LatLng(overlay.bounds[2], overlay.bounds[3])
          );

        var overlay = new google.maps.GroundOverlay(server + overlay.url, bounds);
        overlay.setMap(map);
      });
    });
}

function fetchSegments(park, map) {
  $.ajax(server + park.dir + '/segments').then(function (data) {
    data.forEach(function (seg) {
      fetchAndDisplaySegment(park, map, seg);
    })
  });
}

function fetchAndDisplaySegment(park, map, segment) {
  $.ajax(server + segment).then(function (gpx, textStatus, jqXHR) {
      $gpx = $(gpx);
      var coords = [];
      $gpx.find('trkpt').each(function () {
        coords.push({
          lat: parseFloat($(this).attr('lat')),
          lng: parseFloat($(this).attr('lon'))
        });
      });

      var path = new google.maps.Polyline({
          path: coords,
          geodesic: true,
          strokeColor: '#cc0000',
          strokeOpacity: 0.5,
          strokeWeight: 5
        });

      google.maps.event.addListener(path, 'click', displaySegName($gpx.find('metadata > name').text()));

      path.setMap(map);
    }, function (jqXHR, textStatus, errorThrown) {
      console.log('Error! ' + errorThrown);
    });
}

function displaySegName(name) {
  return function () {
    alert(name);
  }
}

    </script>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqEbiDYhhRnGr4MHqDEq7iK4x0mmp9j50&callback=ready">
    </script>
  </body>
</html>
